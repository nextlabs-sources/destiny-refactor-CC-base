#!/bin/bash
#
# DESCRIPTION
#	This script generates a number of bash variables used in PCV and release build.
#
#	The main objective is to make it easy to rebuild in case of build error. Also build 
#	parameters are explicit so that it is easy to understand or override. This script
#	generates a ./build.config file to be used by ./buildRelease, ./buildPcv and ./buildDev. 
#	Run this script after ./setEnv.
#
# USAGE
#	See printUsage()
#
# NOTES
#	When bash script is run from Hudson, the output string of $(hostname), $(whoami) is return
#	with a trailing '\r'. Use tr to remove the trailing '\r' ($(hostname | tr -d -c [:print:])).


echo "NextLabs Control Center Products Build Configuration Script"
echo "Specify --help for more information"


#
# Process commandline parameters
#

# ------------------------------
# printUsage()

function printUsage
{
	echo "usage: configure [--type=release|pcv_smdc|pcv_cdc|dev] [--mapBuildRoot=<drive>]"
	echo "  mapBuildRoot  Use short path for NLBUILDROOT to avoid Cygwin and InstallShield"
	echo "                path length limitation. Specify a drive letter that NLBUILDROOT is"
	echo "                mapped to (e.g., --mapBuildRoot=k). IMPORTANT: Beware that if you"
	echo "                have two Hudson projects setup to use the same drive, you can"
	echo "                potentially have one project changing drive mapping of another"
	echo "                in the middle of a build and produce unpredictible result. In this"
	echo "                case, you should use a different drive mapping for a second"
	echo "                project."
	echo "  type          Build configuration type. Default is dev. Valid values are:"
	echo "                  release"
	echo "                    BUILD_NUMBER must be specified"
	echo "                  pcv_smdc or pcv_cdc"
	echo "                    BUILD_NUMBER is generated by this script"
	echo "                  dev"
	echo "                    BUILD_NUMBER is generated by this script"
	echo ""
	echo "Environment variables used by this script include:"
	echo "  BUILD_NUMBER=<#>         Valid only for --type=release. Otherwise, auto-generated."
	echo "  NLEXTERNALDIR2=<path>      Must be set by you"
	echo "  NLBUILDROOT=<path>        Will always be set to current directory"
	echo ""
	echo "Environment Variables:"
	echo "  BUILD_NUMBER     = $BUILD_NUMBER"
	echo "  OFFICIALCERT     = $OFFICIALCERT"
	echo "  NLBUILDROOT      = $NLBUILDROOT"
	echo "  NLEXTERNALDIR2   = $NLEXTERNALDIR2"
}

# Help
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	printUsage
	exit 0
fi

# Parse arguements
CONFIG_TYPE=dev
MAP_BUILD_ROOT=

while [ $# -gt 0 ]; do
	if [ "${1%%=*}" == "--type" ]; then
		CONFIG_TYPE=${1##*=}
	elif [ "${1%%=*}" == "--mapBuildRoot" ]; then
		MAP_BUILD_ROOT=${1##*=}
	fi
	
	shift
done

# Check for errors
if [ "$CONFIG_TYPE" != "release" ] &&  [ "$CONFIG_TYPE" != "pcv_smdc" ] \
	&&  [ "$CONFIG_TYPE" != "pcv_cdc" ] &&  [ "$CONFIG_TYPE" != "dev" ]; then
	echo "### ERROR: Invalid config type $CONFIG_TYPE"
	exit 1
fi

# Print arguements
echo "INFO: Parameters:"
echo "  CONFIG_TYPE      = $CONFIG_TYPE"
echo "  MAP_BUILD_ROOT   = $MAP_BUILD_ROOT"


#
# Check for errors
#

MAP_PATH=${MAP_BUILD_ROOT}:/
DESTINY_UI_SRC_TREE_ROOT=$(cygpath -m "$DESTINY_UI_SRC_TREE_ROOT" | tr -d -c [:print:])
TECHPUBS_HELP_ROOT=$(cygpath -m "$TECHPUBS_HELP_ROOT" | tr -d -c [:print:])
NLEXTERNALDIR2=$(cygpath -m "$NLEXTERNALDIR2" | tr -d -c [:print:])
BUILD_NUMBER=$(echo $BUILD_NUMBER | tr -d -c [:digit:])

if [ "$MAP_BUILD_ROOT" != "" ] && [ ! -d $MAP_PATH ]; then
	echo "### ERROR: Invalid mapped build root $MAP_PATH"
	exit 1
fi

if [ "$DESTINY_UI_SRC_TREE_ROOT" == "" ]; then
	echo "### ERROR: Missing variable \$DESTINY_UI_SRC_TREE_ROOT"
	exit 1
fi

if [ "$TECHPUBS_HELP_ROOT" == "" ]; then
	echo "### ERROR: Missing variable \$TECHPUBS_HELP_ROOT"
	exit 1
fi

if [ "$NLEXTERNALDIR2" == "" ]; then
	echo "### ERROR: Missing variable \$NLEXTERNALDIR2"
	exit 1
fi

if [ ! -d "$NLEXTERNALDIR2" ]; then
	echo "### ERROR: Missing external directory $NLEXTERNALDIR2"
	exit 1
fi

if [ "$CONFIG_TYPE" == "release" ] || [ "$CONFIG_TYPE" == "pcv_smdc" ] || [ "$CONFIG_TYPE" == "pcv_cdc" ]; then
#TBF: Should check if BUILD_NUMBER is numeric

	if [ "$BUILD_NUMBER" == "" ] || [ $BUILD_NUMBER -eq 0 ]; then
		echo "### ERROR: Missing or invalid \$BUILD_NUMBER"
		exit 1
	fi
fi


#
# Prepare variables
#

# Set project root
if [ "$MAP_BUILD_ROOT" == "" ]; then
	NLBUILDROOT=$(cygpath -m $(pwd) | tr -d -c [:print:])
else
	NLBUILDROOT=${MAP_BUILD_ROOT}:
fi

# Compiler variables
if [ "$CONFIG_TYPE" == "release" ]; then
	OFFICIALCERT=1
	VERSION_BUILD=$BUILD_NUMBER
	VERSION_BUILD_SHORT=$BUILD_NUMBER
	MAKE_INSTALLFLAGS="-k OFFICIALCERT=$OFFICIALCERT VERSION_BUILD=$VERSION_BUILD"	
elif [ "$CONFIG_TYPE" == "pcv_smdc" ] || [ "$CONFIG_TYPE" == "pcv_cdc" ]; then	
	if [ "$CONFIG_TYPE" == "pcv_smdc" ]; then
		BUILD_CODE=PS
	else
		BUILD_CODE=PC
	fi
	
	BRANCH_NAME=Main

	if [ "$BRANCH_NAME" == "" ]; then
		BRANCH_NAME=$(basename `pwd`)

		if [ "$BRANCH_NAME" == "workspace" ]; then
			BRANCH_NAME=$(basename $(dirname `pwd`))
		fi
	fi
	
	OFFICIALCERT=0
	VERSION_BUILD_SHORT=$BUILD_NUMBER${BUILD_CODE}-$BRANCH_NAME
	VERSION_BUILD=$VERSION_BUILD_SHORT
	MAKE_INSTALLFLAGS="OFFICIALCERT=$OFFICIALCERT VERSION_BUILD=$VERSION_BUILD"
else	
	if [ "$BUILD_NUMBER" == "" ] || [ $BUILD_NUMBER -eq 0 ]; then
		BUILD_NUMBER=10001
	fi

	OFFICIALCERT=0
	VERSION_BUILD_SHORT=${BUILD_NUMBER}DX_$(hostname | tr -d -c [:print:])
	VERSION_BUILD=$VERSION_BUILD_SHORT-$(whoami | tr -d -c [:print:])-$(date +"%Y.%m.%d-%H:%M")
	MAKE_INSTALLFLAGS="OFFICIALCERT=$OFFICIALCERT VERSION_BUILD=$VERSION_BUILD"
fi

# Project info
VERSION_MAJOR=666
VERSION_MINOR=0
VERSION_MAINTENANCE=0
VERSION_PATCH=0
VERSION_STR=${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_MAINTENANCE}.${VERSION_PATCH}
BUILD_DATE=$(date +"%Y%m%d" | tr -d -c [:digit:])
BUILD_DATE_LONG=$(date +"%Y%m%d%H%M" | tr -d -c [:digit:])

# Dependencies used by Makefile.xlib
if [ "$XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE" == "" ]; then
	XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE="S:/build/release_artifacts/Fate/8.0.0.1/4-Nimbus-8.0.3-GA/fate-8.0.0.1-4-release-20161108-bin.zip"
	# rm -f ./build.config.fate
	# perl $NLBUILDROOT/scripts/getNewestProductBuildArtifactFile.pl \
	# 	--startpath=S:/build/release_artifacts/Fate/8.0.0.1 \
	# 	--outfile=build.config.fate --varname=XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE
	# source ./build.config.fate
fi

# Dependencies used by Makefile.xlib
if [ "$XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE" == "" ]; then
	XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE="s:/build/release_artifacts/SharePointEnforcer/7.1.0.1000/6PS_main2010/spe-7.1.0.1000-6PS_main2010-pcv-20140626-bin.zip"
	# rm -f ./build.config.sharepoint
	# perl $NLBUILDROOT/scripts/getNewestProductBuildArtifactFile.pl \
	# 	--startpath=S:/build/release_artifacts/SharePointEnforcer/7.1.0.1000 \
	# 	--outfile=build.config.sharepoint --varname=XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE
	# source ./build.config.sharepoint
fi

if [ "$XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE" == "" ]; then
	XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE="s:/build/release_artifacts/installer/2.0.0.0/11/installer-support-2.0.0.0-11-release-20121203-xlib-bin.zip"
	# rm -f ./build.config.installer
	# perl $NLBUILDROOT/scripts/getNewestProductBuildArtifactFile.pl \
	# 	--startpath=S:/build/release_artifacts/installer/2.0.0.0 \
	# 	--outfile=build.config.installer --varname=XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE
	# source ./build.config.installer
fi

if [ "$OAUTH2JWTSECRET_PLUGIN_ZIP" == "" ]; then
	OAUTH2JWTSECRET_PLUGIN_ZIP="s:/releases/CloudAZ/plugins/Oauth2JWTSecret/8.0.4/7/Oauth2JWTSecret-Plugin-8.0.4-7-201701111944.zip"
fi

if [ "$TECHPUBS_HELP_BUILD_ZIP_FILE" == "" ]; then
	TECHPUBS_HELP_BUILD_ZIP_FILE="s:/build/release_candidate/artifacts/Destiny-Techpubs-Help-OnPremise/8.1.0.0/8/destiny-techpubs-help-onpremise-8.1.0.0-8-201705162033-build.zip"
	# rm -f ./build.config.techpubshelp
	# perl $NLBUILDROOT/scripts/getNewestProductBuildArtifactFile.pl \
	# 	--startpath=S:/build/release_artifacts/Destiny-Techpubs-Help-OnPremise/8.0.3.0 \
	# 	--outfile=build.config.techpubshelp --varname=TECHPUBS_HELP_BUILD_ZIP_FILE
	# if [ -f ./build.config.techpubshelp ] ; then
	# 	source ./build.config.techpubshelp
	# else
	# 	export TECHPUBS_HELP_BUILD_ZIP_FILE="TECHPUBS_HELP_BUILD_ZIP_FILE_NOT_FOUND"
	# fi
fi

if [ "$TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE" == "" ]; then
	TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE="s:/build/release_artifacts/Destiny-Techpubs-Help-SaaS/8.0.6.0/1-CloudAZ-ControlCenter-8.0.6-GA/destiny-techpubs-help-saas-8.0.6.0-1-201703170242-build.zip"
	# rm -f ./build.config.techpubshelpsaas
	# perl $NLBUILDROOT/scripts/getNewestProductBuildArtifactFile.pl \
	# 	--startpath=S:/build/release_artifacts/Destiny-Techpubs-Help-SaaS/8.0.4.0 \
	# 	--outfile=build.config.techpubshelpsaas --varname=TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE
	# if [ -f ./build.config.techpubshelpsaas ] ; then
	# 	source ./build.config.techpubshelpsaas
	# else
	# 	export TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE="TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE_NOT_FOUND"
	# fi
fi

# Locations used by Makefile.publish
SYNC_FOLDER_ROOT=s:/global/Us2Cdc/engineering

if [ "$CONFIG_TYPE" == "release" ]; then
	REPOSITORY_ROOT=s:/build/release_candidate
else
	REPOSITORY_ROOT=s:/build/pcv
fi


#
# Generate build.config
#

# Write file

(
cat <<EOT
#!/bin/bash
#
# Description
#	This script contains variable to be used by ./buildAll script. It can also be used to
#	setup the environment for manual compilation. It is especially useful for partial 
#	rebuilding after fixing compilation problem or incremental build after bug fix.
#
# WARNING
#	This file is generated by ./configure. You may edit this file for debugging because
#	changes will be overriden when ./configure is run.

export CONFIG_TYPE=$CONFIG_TYPE
export VERSION_MAJOR=$VERSION_MAJOR
export VERSION_MINOR=$VERSION_MINOR
export VERSION_MAINTENANCE=$VERSION_MAINTENANCE
export VERSION_PATCH=$VERSION_PATCH
export VERSION_STR=$VERSION_STR
export BUILD_NUMBER=$BUILD_NUMBER
export VERSION_BUILD=$VERSION_BUILD
export VERSION_BUILD_SHORT=$VERSION_BUILD_SHORT
export BUILD_DATE=$BUILD_DATE
export BUILD_DATE_LONG=$BUILD_DATE_LONG
export OFFICIALCERT=$OFFICIALCERT

export XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE=$XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE
export XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE=$XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE
export XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE=$XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE
export OAUTH2JWTSECRET_PLUGIN_ZIP=$OAUTH2JWTSECRET_PLUGIN_ZIP
export TECHPUBS_HELP_BUILD_ZIP_FILE=$TECHPUBS_HELP_BUILD_ZIP_FILE
export TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE=$TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE

export REPOSITORY_ROOT=$REPOSITORY_ROOT
export SYNC_FOLDER_ROOT=$SYNC_FOLDER_ROOT

export NLBUILDROOT=$NLBUILDROOT
export NLEXTERNALDIR2=$NLEXTERNALDIR2
export DESTINY_UI_SRC_TREE_ROOT=$DESTINY_UI_SRC_TREE_ROOT
export TECHPUBS_HELP_ROOT=$TECHPUBS_HELP_ROOT

export MAKE_INSTALLFLAGS="$MAKE_INSTALLFLAGS"
EOT
) > build.config

# Print content of build.config
echo ""
echo "INFO: build.config"

cat build.config


#
# Generate scripts/build.properties
#

# Write file

rm -f scripts/build.properties
(
cat <<EOT
# ---------------------------------------------------------------------------
# Configurable build properties
#
# Description:
#	The properties in this file are configurable properties. They should be updated 
#	according to the environment and release version. The properties should are used
#	by build_xlib.xml, build_compile.xml and build_publish.xml. This property file
#	should contain all the properties to run any of these Ant scripts. If any 
#	configurable property is missing, it should be added to this script.
#
#	Note that this script should not contain any property that acts a local variable
#	to a build.xml file. Those should be specified in the build.xml file using
#	<properties> tag.
#
#	For developer:
#		The values specified in this property file need to be adjusted in order for 
#		you to compile code in you development environment using build_compile.xml. 
#		Since this property file contains all configurable properties needed to
#		build a source tree, you should be able to build after updating this file.
#		You may compile using compileIt.bat or run Ant at a command prompt.
#
#	For build machine:
#		To perform scripted build, we may generate this build.properties file
#		on-the-fly or use Ant commandline to override the properties. Ant commandline
#		can be specified through environment varibale ANT_ARGS. In either case, specify
#		-D<name>=<value> to override a property.
#
# Notes: The properties major.version, minor.version, maintenance.version, patch.version
# and build.nunmber will supercede values attempted to be set in 
# $NLBUILDROOT/build_scripts/verson_build.xml. This is because Ant property is immutable.
# ---------------------------------------------------------------------------

# Source and libraries
external.dir=$NLEXTERNALDIR2

# Xlib (build artifacts from various products)
xlib_fate_build_artifacts_bin_zip_file=$XLIB_FATE_BUILD_ARTIFACTS_BIN_ZIP_FILE
xlib_sharepoint_build_artifacts_bin_zip_file=$XLIB_SHAREPOINT_BUILD_ARTIFACTS_BIN_ZIP_FILE
xlib_installer_build_artifacts_xlib_bin_zip_file=$XLIB_INSTALLER_BUILD_ARTIFACTS_XLIB_BIN_ZIP_FILE
oauth2jwtsecret_plugin_zip=$OAUTH2JWTSECRET_PLUGIN_ZIP
techpubs_help_build_zip_file=$TECHPUBS_HELP_BUILD_ZIP_FILE
techpubs_help_saas_build_zip_file=$TECHPUBS_HELP_SAAS_BUILD_ZIP_FILE

# Build variables
version_str=$VERSION_STR
build_number=$BUILD_NUMBER
version_build_short=$VERSION_BUILD_SHORT
build_date_long=$BUILD_DATE_LONG
repository_root=$REPOSITORY_ROOT

# Version.jar and src/installer/build.xml variables
major.version=$VERSION_MAJOR
minor.version=$VERSION_MINOR
maintenance.version=$VERSION_MAINTENANCE
patch.version=$VERSION_PATCH
build.number=$BUILD_NUMBER
build.version=$BUILD_NUMBER
EOT
) > scripts/build.properties

# Print content of scripts/build.properties
echo ""
echo "INFO: scripts/build.properties"

cat scripts/build.properties
